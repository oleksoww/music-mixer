<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audio Mixer</title>
<style>
body{font-family:Arial,sans-serif;background:#121212;color:#fff;text-align:center;padding:20px;}
input,button{margin:10px;padding:10px;border-radius:6px;border:none;}
button{cursor:pointer;background:#6200ea;color:white;font-weight:bold;}
button:disabled{opacity:0.5;cursor:not-allowed;}
audio{width:80%;margin-top:15px;}
</style>
</head>
<body>
<h1>ðŸŽ¶ Audio Mixer</h1>
<p>Wgraj wokal i beat, miksuj i pobierz wynik.</p>

<h2>Wgraj pliki</h2>
<input type="file" id="vocalFile" accept="audio/*"><br>
<input type="file" id="beatFile" accept="audio/*"><br>
<label>GÅ‚oÅ›noÅ›Ä‡ wokalu: <input type="range" id="gainVocal" min="0" max="2" step="0.01" value="1"></label><br>
<label>GÅ‚oÅ›noÅ›Ä‡ beatu: <input type="range" id="gainBeat" min="0" max="2" step="0.01" value="1"></label><br>
<button id="btnMakeMix" disabled>Pobierz mix.wav</button>
<button id="btnPreviewMix" disabled>PodglÄ…d miksu â–¶</button><br>
<audio id="previewMix" controls hidden></audio>

<script>
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
const vocalFile = document.getElementById('vocalFile');
const beatFile = document.getElementById('beatFile');
const btnMakeMix = document.getElementById('btnMakeMix');
const btnPreviewMix = document.getElementById('btnPreviewMix');
const previewMix = document.getElementById('previewMix');
const gainVocal = document.getElementById('gainVocal');
const gainBeat = document.getElementById('gainBeat');

let loadedVocal = null;
let loadedBeat = null;

async function decodeFile(file){
    const arr = await file.arrayBuffer();
    return await audioCtx.decodeAudioData(arr.slice(0));
}

async function bufferToBlob(buffer){
    const numCh = buffer.numberOfChannels;
    const sr = buffer.sampleRate;
    const L = buffer.getChannelData(0);
    const R = numCh>1?buffer.getChannelData(1):L;
    const interleave = new Float32Array(L.length*2);
    for(let i=0;i<L.length;i++){interleave[i*2]=L[i]; interleave[i*2+1]=R[i];}
    const pcm16 = new Int16Array(interleave.length);
    for(let i=0;i<interleave.length;i++){let s=Math.max(-1,Math.min(1,interleave[i])); pcm16[i]=s<0?s*0x8000:s*0x7FFF;}
    const wav = new ArrayBuffer(44 + pcm16.byteLength);
    const view = new DataView(wav);
    let offset=0;
    function wS(o,s){for(let i=0;i<s.length;i++)view.setUint8(o+i,s.charCodeAt(i));}
    wS(offset,"RIFF"); offset+=4;
    view.setUint32(offset,36+pcm16.byteLength,true); offset+=4;
    wS(offset,"WAVE"); offset+=4;
    wS(offset,"fmt "); offset+=4;
    view.setUint32(offset,16,true); offset+=4;
    view.setUint16(offset,1,true); offset+=2;
    view.setUint16(offset,numCh,true); offset+=2;
    view.setUint32(offset,sr,true); offset+=4;
    view.setUint32(offset,sr*2*numCh,true); offset+=4;
    view.setUint16(offset,numCh*2,true); offset+=2;
    view.setUint16(offset,16,true); offset+=2;
    wS(offset,"data"); offset+=4;
    view.setUint32(offset,pcm16.byteLength,true); offset+=4;
    new Int16Array(wav,44).set(pcm16);
    return new Blob([wav],{type:"audio/wav"});
}

async function downloadBuffer(buffer, filename){
    const blob = await bufferToBlob(buffer);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
}

async function playBuffer(buffer, player){
    const blob = await bufferToBlob(buffer);
    const url = URL.createObjectURL(blob);
    player.src = url;
    player.hidden=false;
    player.play();
}

vocalFile.addEventListener('change', async()=>{if(!vocalFile.files[0]) return; loadedVocal = await decodeFile(vocalFile.files[0]); checkMix();});
beatFile.addEventListener('change', async()=>{if(!beatFile.files[0]) return; loadedBeat = await decodeFile(beatFile.files[0]); checkMix();});

function checkMix(){ btnMakeMix.disabled = !(loadedVocal&&loadedBeat); btnPreviewMix.disabled = !(loadedVocal&&loadedBeat); }

async function makeMixBuffer(){
    if(!loadedVocal||!loadedBeat) return null;
    const len = Math.max(loadedVocal.length, loadedBeat.length);
    const out = audioCtx.createBuffer(2,len,audioCtx.sampleRate);
    for(let ch=0;ch<2;ch++){
        const dV = loadedVocal.getChannelData(ch);
        const dB = loadedBeat.getChannelData(ch);
        const o = out.getChannelData(ch);
        for(let i=0;i<len;i++){
            const v = i<dV.length ? dV[i]*gainVocal.value : 0;
            const b = i<dB.length ? dB[i]*gainBeat.value : 0;
            o[i] = Math.tanh(v+b);
        }
    }
    return out;
}

btnMakeMix.addEventListener('click', async()=>{
    const mix = await makeMixBuffer();
    if(mix) await downloadBuffer(mix,"mix.wav");
});

btnPreviewMix.addEventListener('click', async()=>{
    const mix = await makeMixBuffer();
    if(mix) await playBuffer(mix,previewMix);
});
</script>
</body>
</html>
